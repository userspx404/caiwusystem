import{a as C,r as de,n as ce,o as Ve,b as d,p as Ne,c as M,d as f,e as s,f as t,z as _,H as T,g as o,w as a,u as L,l as Ie,q as Ee,t as b,B as pe,I as Re,F as Ue,C as Be,G as X,E as m,D as Z}from"./index-CAVot8kD.js";import{_ as Se,a as $e,t as Y,d as ze}from"./_plugin-vue_export-helper-CZBBfLPA.js";const Fe={class:"transaction-management",style:{padding:"20px"}},Oe={class:"page-header"},Me={class:"page-title"},Le={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Ye={style:{display:"flex","justify-content":"space-between","align-items":"center"}},je={style:{display:"flex",gap:"10px","justify-content":"center"}},Pe={key:1},We={style:{display:"flex","justify-content":"space-between","align-items":"center"}},He={style:{"margin-top":"20px",padding:"15px",background:"#f5f7fa","border-radius":"4px"}},qe={style:{"text-align":"right","margin-top":"20px"}},Ge={key:1,style:{"margin-top":"20px"}},Je={class:"amount-text"},Ke={__name:"TransactionManagement",setup(Qe){const j=C([]),me=()=>{try{const l=localStorage.getItem("auth_roles");j.value=l?JSON.parse(l):[]}catch{j.value=[]}},S=l=>j.value.includes(l),D=C([]),N=C([]),$=C(!1),z=C(null),P=C(!1),W=C(!1),I=C(!1),x=C(!1),v=C(null),w=de({voucherNo:"",status:""}),r=de({id:null,voucherNo:"",date:new Date().toISOString().split("T")[0],description:"",status:"DRAFT",splits:[]}),k=ce(()=>{const l=r.splits.filter(i=>i.balanceDirection==="DEBIT").reduce((i,y)=>i+(Number(y.amount)||0),0),e=r.splits.filter(i=>i.balanceDirection==="CREDIT").reduce((i,y)=>i+(Number(y.amount)||0),0),u=Math.abs(l-e),g=u<.01&&r.splits.length>0;return{debitTotal:l,creditTotal:e,difference:u,isBalanced:g,debitClass:l>0?"amount-text positive":"amount-text",creditClass:e>0?"amount-text positive":"amount-text",differenceClass:g?"amount-text positive":"amount-text negative"}}),F=l=>l==null?"0.00":Number(l).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),ee=l=>l?typeof l=="string"?l:new Date(l).toLocaleDateString("zh-CN"):"-",H=l=>({DRAFT:"info",AUDITED:"warning",POSTED:"success",CANCELLED:"danger"})[l]||"",q=l=>({DRAFT:"草稿",AUDITED:"已审核",POSTED:"已过账",CANCELLED:"已作废"})[l]||l,te=async()=>{try{const l=await $e.getAllAccounts();D.value=Array.isArray(l)?l:[]}catch(l){console.error("获取科目列表失败:",l),m.error(l.message||"获取科目列表失败"),D.value=[]}},fe=(l,e)=>{const u=D.value.find(g=>g.id===e.accountId);u&&(e.accountCode=u.code,e.accountName=u.name,u.balanceDirection&&(e.balanceDirection=u.balanceDirection))},G=()=>{r.splits.push({accountId:null,accountCode:"",accountName:"",balanceDirection:"DEBIT",amount:0,description:""})},ve=l=>{r.splits.splice(l,1)},ge=ce(()=>{try{if(!Array.isArray(N.value))return[];let l=N.value;return w.voucherNo&&(l=l.filter(e=>{var u;return(u=e==null?void 0:e.voucherNo)==null?void 0:u.toLowerCase().includes(w.voucherNo.toLowerCase())})),w.status&&(l=l.filter(e=>(e==null?void 0:e.status)===w.status)),l}catch(l){return console.error("filteredTransactions 計算錯誤:",l),[]}}),E=async()=>{$.value=!0;try{const l=await Y.getAllTransactions();N.value=Array.isArray(l)?l:[],N.value.length===0&&console.log("憑證列表為空，但請求成功")}catch(l){console.error("獲取憑證列表失敗:",l);const e=l.message||"獲取憑證列表失敗";l.code==="NETWORK_ERROR"?m.error({message:e,duration:5e3,showClose:!0}):m.error(e),N.value=[]}finally{$.value=!1}},ye=()=>{},_e=()=>{w.voucherNo="",w.status=""},le=l=>l?l.status==="DRAFT":!1,ae=l=>l?l.status==="DRAFT"||l.status==="AUDITED":!1,be=l=>{v.value={...l},x.value=!0},ne=async l=>{try{await Z.confirm(`確定要審核憑證「${l.voucherNo}」嗎？`,"確認審核",{confirmButtonText:"確定",cancelButtonText:"取消",type:"warning"}),await Y.auditTransaction(l.id,1),m.success("審核成功！"),await E(),x.value&&(x.value=!1)}catch(e){e!=="cancel"&&(console.error("審核失敗:",e),m.error(e.message||"審核失敗"))}},oe=async l=>{try{await Z.confirm(`確定要作廢憑證「${l.voucherNo}」嗎？`,"確認作廢",{confirmButtonText:"確定",cancelButtonText:"取消",type:"warning"}),await Y.cancelTransaction(l.id),m.success("作廢成功！"),await E(),x.value&&(x.value=!1)}catch(e){e!=="cancel"&&(console.error("作廢失敗:",e),m.error(e.message||"作廢失敗"))}},J=()=>{I.value=!0,z.value={id:Date.now()},Object.assign(r,{id:null,voucherNo:"",date:new Date().toISOString().split("T")[0],description:"",status:"DRAFT",splits:[]}),G(),G()},we=async()=>{try{if(D.value.length===0&&await te(),D.value.length<2){m.warning("请先在「科目管理」中创建至少两个科目");return}const l=D.value.find(u=>{var g,i,y;return((g=u.name)==null?void 0:g.includes("现金"))||((i=u.name)==null?void 0:i.includes("银行"))||((y=u.code)==null?void 0:y.startsWith("1"))})||D.value[0],e=D.value.find(u=>{var g,i,y,h;return((g=u.name)==null?void 0:g.includes("收入"))||((i=u.name)==null?void 0:i.includes("应付"))||((y=u.code)==null?void 0:y.startsWith("4"))||((h=u.code)==null?void 0:h.startsWith("2"))})||D.value[1];I.value=!0,z.value={id:Date.now()},Object.assign(r,{id:null,voucherNo:`VOUCHER-${new Date().getTime()}`,date:new Date().toISOString().split("T")[0],description:"测试凭证：销售商品收到现金",status:"DRAFT",splits:[{accountId:l.id,accountCode:l.code,accountName:l.name,balanceDirection:"DEBIT",amount:1e4,description:"收到现金"},{accountId:e.id,accountCode:e.code,accountName:e.name,balanceDirection:"CREDIT",amount:1e4,description:"销售收入"}]}),m.success(`测试凭证已创建！这是一个借贷平衡的示例：
借方（现金）10,000.00 = 贷方（收入）10,000.00`)}catch(l){console.error("创建测试凭证失败:",l),m.error(l.message||"创建测试凭证失败")}},se=()=>{I.value=!1,z.value=null,r.splits=[]},De=async()=>{if(!r.date){m.warning("请选择凭证日期");return}if(r.splits.length<2){m.warning("至少需要两条分录");return}if(!k.value.isBalanced){m.warning("借贷不平衡，无法保存");return}for(let l=0;l<r.splits.length;l++){const e=r.splits[l];if(!e.accountId){m.warning(`第 ${l+1} 条分录未选择科目`);return}if(!e.amount||e.amount<=0){m.warning(`第 ${l+1} 条分录金额无效`);return}}try{P.value=!0;const l={voucherNo:r.voucherNo||null,date:r.date,description:r.description,status:"DRAFT",splits:r.splits.map(e=>({accountId:e.accountId,balanceDirection:e.balanceDirection,amount:e.amount,description:e.description||""}))};await Y.createTransaction(l),m.success("凭证保存成功"),se(),await E(),I.value=!1}catch(l){console.error("保存凭证失败:",l),m.error(l.message||"保存凭证失败")}finally{P.value=!1}},he=async()=>{try{await Z.confirm(`确定要执行批量过账操作吗？
这将把所有状态为「已审核」的凭证批量过账为「已过账」状态。`,"确认批量过账",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),W.value=!0;const l=await ze.batchPostTransactions();m.success(`批量过账成功！共过账 ${l.transactionsPosted||0} 条凭证`),await E()}catch(l){l!=="cancel"&&(console.error("批量过账失败:",l),m.error(l.message||"批量过账失败"))}finally{W.value=!1}};return Ve(()=>{me(),te(),E()}),(l,e)=>{const u=d("el-icon"),g=d("el-alert"),i=d("el-button"),y=d("el-input"),h=d("el-form-item"),A=d("el-option"),K=d("el-select"),ie=d("el-form"),R=d("el-card"),re=d("el-empty"),c=d("el-table-column"),O=d("el-tag"),Q=d("el-table"),U=d("el-col"),Ce=d("el-date-picker"),ue=d("el-row"),Te=d("el-input-number"),B=d("el-descriptions-item"),xe=d("el-descriptions"),ke=d("el-dialog"),Ae=Ne("loading");return f(),M("div",Fe,[s("div",Oe,[s("h1",Me,[t(u,{class:"title-icon"},{default:a(()=>[t(L(Ie))]),_:1}),e[10]||(e[10]=o(" 凭证录入与审核 ",-1))]),e[11]||(e[11]=s("p",{class:"page-subtitle"},"录入会计凭证，确保借贷平衡",-1))]),t(g,{type:"info",closable:!1,style:{"margin-bottom":"20px"}},{title:a(()=>[...e[12]||(e[12]=[s("div",{style:{"font-size":"14px","line-height":"1.6"}},[s("strong",null,"使用说明："),s("br"),o(" 1. 凭证必须至少包含两条分录（一借一贷）"),s("br"),o(" 2. "),s("strong",null,"借方合计 = 贷方合计"),o("（借贷必须平衡）"),s("br"),o(" 3. 示例：销售商品收到现金 10,000 元"),s("br"),o("    → 借方：现金 10,000（资产增加）"),s("br"),o("    → 贷方：销售收入 10,000（收入增加）"),s("br"),o(" 4. 点击「创建测试凭证示例」查看完整示例 ")],-1)])]),_:1}),t(R,{class:"list-card",shadow:"hover",style:{"margin-bottom":"20px"}},{header:a(()=>[s("div",Le,[e[15]||(e[15]=s("span",{style:{"font-size":"18px","font-weight":"600"}},"凭证列表",-1)),s("div",null,[S("ACCOUNTANT")?(f(),_(i,{key:0,type:"primary",onClick:J},{default:a(()=>[t(u,null,{default:a(()=>[t(L(pe))]),_:1}),e[13]||(e[13]=o(" 新增凭证 ",-1))]),_:1})):T("",!0),S("AUDITOR")?(f(),_(i,{key:1,type:"success",onClick:he,loading:W.value,style:{"margin-left":"10px"}},{default:a(()=>[t(u,null,{default:a(()=>[t(L(Re))]),_:1}),e[14]||(e[14]=o(" 批量过账 ",-1))]),_:1},8,["loading"])):T("",!0)])])]),default:a(()=>[t(R,{class:"search-card",shadow:"never",style:{"margin-bottom":"20px"}},{default:a(()=>[t(ie,{inline:!0,model:w},{default:a(()=>[t(h,{label:"凭证号码"},{default:a(()=>[t(y,{modelValue:w.voucherNo,"onUpdate:modelValue":e[0]||(e[0]=n=>w.voucherNo=n),placeholder:"请输入凭证号码",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(h,{label:"状态"},{default:a(()=>[t(K,{modelValue:w.status,"onUpdate:modelValue":e[1]||(e[1]=n=>w.status=n),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:a(()=>[t(A,{label:"草稿",value:"DRAFT"}),t(A,{label:"已审核",value:"AUDITED"}),t(A,{label:"已过账",value:"POSTED"}),t(A,{label:"已作废",value:"CANCELLED"})]),_:1},8,["modelValue"])]),_:1}),t(h,null,{default:a(()=>[t(i,{type:"primary",onClick:ye},{default:a(()=>[...e[16]||(e[16]=[o("查询",-1)])]),_:1}),t(i,{onClick:_e},{default:a(()=>[...e[17]||(e[17]=[o("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),!$.value&&N.value.length===0?(f(),_(re,{key:0,description:"暂无凭证数据，点击「新增凭证」开始录入","image-size":120},{default:a(()=>[t(i,{type:"primary",onClick:J},{default:a(()=>[...e[18]||(e[18]=[o("新增凭证",-1)])]),_:1})]),_:1})):Ee((f(),_(Q,{key:1,data:ge.value,stripe:"",style:{width:"100%"}},{default:a(()=>[t(c,{prop:"id",label:"凭证ID",width:"100"}),t(c,{prop:"voucherNo",label:"凭证号码",width:"180"}),t(c,{prop:"date",label:"凭证日期",width:"120"},{default:a(({row:n})=>[o(b(ee(n.date)),1)]),_:1}),t(c,{prop:"description",label:"摘要","min-width":"200","show-overflow-tooltip":""}),t(c,{prop:"status",label:"状态",width:"120"},{default:a(({row:n})=>[t(O,{type:H(n.status)},{default:a(()=>[o(b(q(n.status)),1)]),_:2},1032,["type"])]),_:1}),t(c,{label:"分录数",width:"100",align:"center"},{default:a(({row:n})=>{var p;return[o(b(((p=n.splits)==null?void 0:p.length)||0),1)]}),_:1}),t(c,{label:"操作",width:"250"},{default:a(({row:n})=>[t(i,{type:"info",size:"small",onClick:p=>be(n)},{default:a(()=>[...e[19]||(e[19]=[o(" 查看 ",-1)])]),_:1},8,["onClick"]),le(n)&&S("AUDITOR")?(f(),_(i,{key:0,type:"warning",size:"small",onClick:p=>ne(n),style:{"margin-left":"8px"}},{default:a(()=>[...e[20]||(e[20]=[o(" 审核 ",-1)])]),_:1},8,["onClick"])):T("",!0),ae(n)&&S("AUDITOR")?(f(),_(i,{key:1,type:"danger",size:"small",onClick:p=>oe(n),style:{"margin-left":"8px"}},{default:a(()=>[...e[21]||(e[21]=[o(" 作废 ",-1)])]),_:1},8,["onClick"])):T("",!0)]),_:1})]),_:1},8,["data"])),[[Ae,$.value]])]),_:1}),I.value?(f(),_(R,{key:0,class:"main-card",shadow:"hover"},{header:a(()=>[s("div",Ye,[e[23]||(e[23]=s("span",{style:{"font-size":"18px","font-weight":"600"}},"凭证录入",-1)),t(i,{onClick:e[2]||(e[2]=n=>I.value=!1)},{default:a(()=>[...e[22]||(e[22]=[o("关闭",-1)])]),_:1})])]),default:a(()=>[z.value?(f(),M("div",Pe,[t(R,{class:"form-card",shadow:"never",style:{"margin-bottom":"20px"}},{default:a(()=>[t(ie,{model:r,"label-width":"120px"},{default:a(()=>[t(ue,{gutter:20},{default:a(()=>[t(U,{span:12},{default:a(()=>[t(h,{label:"凭证号码"},{default:a(()=>[t(y,{modelValue:r.voucherNo,"onUpdate:modelValue":e[3]||(e[3]=n=>r.voucherNo=n),placeholder:"自动生成或手动输入"},null,8,["modelValue"])]),_:1})]),_:1}),t(U,{span:12},{default:a(()=>[t(h,{label:"凭证日期"},{default:a(()=>[t(Ce,{modelValue:r.date,"onUpdate:modelValue":e[4]||(e[4]=n=>r.date=n),type:"date",placeholder:"选择日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(h,{label:"摘要"},{default:a(()=>[t(y,{modelValue:r.description,"onUpdate:modelValue":e[5]||(e[5]=n=>r.description=n),type:"textarea",rows:2,placeholder:"请输入凭证摘要"},null,8,["modelValue"])]),_:1}),t(h,{label:"状态"},{default:a(()=>[t(O,{type:H(r.status)},{default:a(()=>[o(b(q(r.status)),1)]),_:1},8,["type"])]),_:1})]),_:1},8,["model"])]),_:1}),t(R,{class:"splits-card",shadow:"never",style:{"margin-bottom":"20px"}},{header:a(()=>[s("div",We,[e[27]||(e[27]=s("span",null,"凭证分录",-1)),t(i,{type:"primary",size:"small",onClick:G},{default:a(()=>[t(u,null,{default:a(()=>[t(L(pe))]),_:1}),e[26]||(e[26]=o(" 添加分录 ",-1))]),_:1})])]),default:a(()=>[t(Q,{data:r.splits,border:"",style:{width:"100%"}},{default:a(()=>[t(c,{type:"index",label:"序号",width:"60"}),t(c,{label:"科目","min-width":"200"},{default:a(({row:n,$index:p})=>[t(K,{modelValue:n.accountId,"onUpdate:modelValue":V=>n.accountId=V,placeholder:"选择科目",filterable:"",style:{width:"100%"},onChange:V=>fe(p,n)},{default:a(()=>[(f(!0),M(Ue,null,Be(D.value,V=>(f(),_(A,{key:V.id,label:`${V.code} - ${V.name}`,value:V.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),t(c,{label:"方向",width:"120"},{default:a(({row:n})=>[t(K,{modelValue:n.balanceDirection,"onUpdate:modelValue":p=>n.balanceDirection=p,style:{width:"100%"}},{default:a(()=>[t(A,{label:"借方",value:"DEBIT"}),t(A,{label:"贷方",value:"CREDIT"})]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),t(c,{label:"金额",width:"150"},{default:a(({row:n})=>[t(Te,{modelValue:n.amount,"onUpdate:modelValue":p=>n.amount=p,min:0,precision:2,step:100,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),t(c,{label:"摘要","min-width":"200"},{default:a(({row:n})=>[t(y,{modelValue:n.description,"onUpdate:modelValue":p=>n.description=p,placeholder:"分录摘要"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),t(c,{label:"操作",width:"100"},{default:a(({$index:n})=>[t(i,{type:"danger",size:"small",onClick:p=>ve(n)},{default:a(()=>[...e[28]||(e[28]=[o(" 删除 ",-1)])]),_:1},8,["onClick"])]),_:1})]),_:1},8,["data"]),s("div",He,[t(ue,{gutter:20},{default:a(()=>[t(U,{span:8},{default:a(()=>[s("div",null,[e[29]||(e[29]=s("strong",null,"借方合计：",-1)),s("span",{class:X(k.value.debitClass)},b(F(k.value.debitTotal)),3)])]),_:1}),t(U,{span:8},{default:a(()=>[s("div",null,[e[30]||(e[30]=s("strong",null,"贷方合计：",-1)),s("span",{class:X(k.value.creditClass)},b(F(k.value.creditTotal)),3)])]),_:1}),t(U,{span:8},{default:a(()=>[s("div",null,[e[31]||(e[31]=s("strong",null,"差额：",-1)),s("span",{class:X(k.value.differenceClass)},b(F(k.value.difference)),3)])]),_:1})]),_:1}),k.value.isBalanced?(f(),_(g,{key:0,type:"success",closable:!1,style:{"margin-top":"10px"}},{default:a(()=>[...e[32]||(e[32]=[o(" 借贷平衡，可以保存 ",-1)])]),_:1})):(f(),_(g,{key:1,type:"warning",closable:!1,style:{"margin-top":"10px"}},{default:a(()=>[...e[33]||(e[33]=[o(" 借贷不平衡，请检查分录金额 ",-1)])]),_:1}))])]),_:1}),s("div",qe,[t(i,{onClick:se},{default:a(()=>[...e[34]||(e[34]=[o("取消",-1)])]),_:1}),t(i,{type:"primary",onClick:De,loading:P.value},{default:a(()=>[...e[35]||(e[35]=[o(" 保存凭证 ",-1)])]),_:1},8,["loading"])])])):(f(),_(re,{key:0,description:"暂无凭证数据，点击「新增凭证」开始录入","image-size":120},{default:a(()=>[s("div",je,[t(i,{type:"primary",onClick:J},{default:a(()=>[...e[24]||(e[24]=[o("新增凭证",-1)])]),_:1}),t(i,{type:"success",onClick:we},{default:a(()=>[...e[25]||(e[25]=[o("创建测试凭证示例",-1)])]),_:1})])]),_:1}))]),_:1})):T("",!0),t(ke,{modelValue:x.value,"onUpdate:modelValue":e[9]||(e[9]=n=>x.value=n),title:"凭证详情",width:"900px"},{footer:a(()=>[t(i,{onClick:e[6]||(e[6]=n=>x.value=!1)},{default:a(()=>[...e[37]||(e[37]=[o("关闭",-1)])]),_:1}),le(v.value)?(f(),_(i,{key:0,type:"warning",onClick:e[7]||(e[7]=n=>ne(v.value)),style:{"margin-left":"10px"}},{default:a(()=>[...e[38]||(e[38]=[o(" 审核 ",-1)])]),_:1})):T("",!0),ae(v.value)?(f(),_(i,{key:1,type:"danger",onClick:e[8]||(e[8]=n=>oe(v.value)),style:{"margin-left":"10px"}},{default:a(()=>[...e[39]||(e[39]=[o(" 作废 ",-1)])]),_:1})):T("",!0)]),default:a(()=>{var n;return[v.value?(f(),_(xe,{key:0,column:2,border:""},{default:a(()=>[t(B,{label:"凭证ID"},{default:a(()=>[o(b(v.value.id),1)]),_:1}),t(B,{label:"凭证号码"},{default:a(()=>[o(b(v.value.voucherNo),1)]),_:1}),t(B,{label:"凭证日期"},{default:a(()=>[o(b(ee(v.value.date)),1)]),_:1}),t(B,{label:"状态"},{default:a(()=>[t(O,{type:H(v.value.status)},{default:a(()=>[o(b(q(v.value.status)),1)]),_:1},8,["type"])]),_:1}),t(B,{label:"摘要",span:2},{default:a(()=>[o(b(v.value.description||"-"),1)]),_:1})]),_:1})):T("",!0),(n=v.value)!=null&&n.splits&&v.value.splits.length>0?(f(),M("div",Ge,[e[36]||(e[36]=s("h3",{style:{"margin-bottom":"15px","font-size":"16px",color:"#303133"}},"凭证分录",-1)),t(Q,{data:v.value.splits,border:"",style:{width:"100%"}},{default:a(()=>[t(c,{type:"index",label:"序号",width:"60"}),t(c,{prop:"accountCode",label:"科目代码",width:"120"}),t(c,{prop:"accountName",label:"科目名称","min-width":"200"}),t(c,{prop:"balanceDirection",label:"方向",width:"100"},{default:a(({row:p})=>[t(O,{type:p.balanceDirection==="DEBIT"?"success":"warning",size:"small"},{default:a(()=>[o(b(p.balanceDirection==="DEBIT"?"借方":"贷方"),1)]),_:2},1032,["type"])]),_:1}),t(c,{prop:"amount",label:"金额",width:"150",align:"right"},{default:a(({row:p})=>[s("span",Je,b(F(p.amount)),1)]),_:1}),t(c,{prop:"description",label:"摘要","min-width":"200"})]),_:1},8,["data"])])):T("",!0)]}),_:1},8,["modelValue"])])}}},et=Se(Ke,[["__scopeId","data-v-4e714d52"]]);export{et as default};
