import{a as m,r as H,n as ve,o as ge,b as n,p as _e,c as j,d as v,e as w,f as l,g as s,w as a,z as N,q as ye,t as p,H as M,u as Ne,B as be,F as De,C as we,E as d,D as Ce}from"./index-CAVot8kD.js";import{_ as Ae,s as C,c as E}from"./_plugin-vue_export-helper-CZBBfLPA.js";const Ve={class:"sales-order-management",style:{padding:"20px"}},Ie={class:"page-header"},Se={class:"page-title"},Oe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},ke={__name:"SalesOrderManagement",setup(xe){const A=m([]),J=()=>{try{const t=localStorage.getItem("auth_roles");A.value=t?JSON.parse(t):[]}catch{A.value=[]}},G=t=>A.value.includes(t),K=(...t)=>t.some(e=>A.value.includes(e)),V=m([]),x=m([]),I=m(!1),b=m(!1),S=m(!1),h=m(!1),O=m(null),c=m(null),r=H({invoiceNo:"",customerName:"",status:""}),i=H({customerId:null,invoiceNo:"",invoiceDate:"",totalAmount:0}),Q={customerId:[{required:!0,message:"请选择客户",trigger:"change"}],invoiceNo:[{required:!0,message:"请输入发票号码",trigger:"blur"}],invoiceDate:[{required:!0,message:"请选择发票日期",trigger:"change"}],totalAmount:[{required:!0,message:"请输入订单金额",trigger:"blur"},{type:"number",min:.01,message:"订单金额必须大于 0",trigger:"blur"}]},R=ve(()=>{try{if(!Array.isArray(V.value))return[];let t=V.value;return r.invoiceNo&&(t=t.filter(e=>{var f;return(f=e==null?void 0:e.invoiceNo)==null?void 0:f.toLowerCase().includes(r.invoiceNo.toLowerCase())})),r.customerName&&(t=t.filter(e=>{var f;return(f=e==null?void 0:e.customerName)==null?void 0:f.toLowerCase().includes(r.customerName.toLowerCase())})),r.status&&(t=t.filter(e=>(e==null?void 0:e.status)===r.status)),t}catch(t){return console.error("filteredSalesOrders 計算錯誤:",t),[]}}),L=t=>t==null?"0.00":Number(t).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),F=t=>t?typeof t=="string"?t:new Date(t).toLocaleDateString("zh-CN"):"-",U=t=>({DRAFT:"info",CONFIRMED:"",SHIPPED:"warning",INVOICED:"success",CANCELLED:"danger"})[t]||"",B=t=>({DRAFT:"草稿",CONFIRMED:"已确认",SHIPPED:"已发货",INVOICED:"已开票",CANCELLED:"已取消"})[t]||t,W=t=>t.status==="DRAFT"||t.status==="CONFIRMED",D=async()=>{I.value=!0;try{const t=await C.getAllSalesOrders();V.value=Array.isArray(t)?t:[]}catch(t){console.error("獲取訂單列表失敗:",t),d.error(t.message||"獲取訂單列表失敗，請檢查後端服務是否啟動"),V.value=[]}finally{I.value=!1}},X=async()=>{try{const t=await E.getAllCustomers();x.value=Array.isArray(t)?t:[]}catch(t){console.error("獲取客戶列表失敗:",t),x.value=[]}},Z=async()=>{try{const t=await E.getAllCustomers();if(!t||t.length===0){d.info("没有客户数据，正在创建测试客户...");const k=await E.createCustomer({customerName:"测试客户",taxId:"TEST001",creditLimit:1e5,settlementCurrency:"CNY",status:"有效"});d.success("测试客户创建成功");const u=await C.createSalesOrder({customerId:k.id,invoiceNo:"INV-"+new Date().getTime(),invoiceDate:new Date().toISOString().split("T")[0],totalAmount:5e3});d.success("测试订单创建成功！"),await D();return}const e=t[0],f=await C.createSalesOrder({customerId:e.id,invoiceNo:"INV-"+new Date().getTime(),invoiceDate:new Date().toISOString().split("T")[0],totalAmount:5e3});d.success("测试订单创建成功！"),await D()}catch(t){console.error("创建测试订单失败:",t),d.error(t.message||"创建测试订单失败")}},ee=()=>{},te=()=>{r.invoiceNo="",r.customerName="",r.status=""},Y=()=>{se(),b.value=!0},le=t=>{c.value={...t},S.value=!0},ae=async t=>{try{await Ce.confirm(`确定要对订单「${t.invoiceNo}」执行发货开票操作吗？`,"确认发货开票",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}),await C.shipAndInvoiceOrder(t.id),d.success("发货开票成功！"),await D()}catch(e){e!=="cancel"&&(console.error("發貨開票失敗:",e),d.error(e.message||"發貨開票失敗"))}},oe=async()=>{if(O.value)try{await O.value.validate(),h.value=!0;const t={customerId:i.customerId,invoiceNo:i.invoiceNo,invoiceDate:i.invoiceDate,totalAmount:i.totalAmount};await C.createSalesOrder(t),d.success("新增订单成功"),b.value=!1,await D()}catch(t){t!==!1&&(console.error("提交失敗:",t),d.error(t.message||"提交失敗"))}finally{h.value=!1}},se=()=>{var t;Object.assign(i,{customerId:null,invoiceNo:"",invoiceDate:"",totalAmount:0}),(t=O.value)==null||t.clearValidate()};return ge(()=>{console.log("SalesOrderManagement 組件已掛載"),J(),D(),X()}),(t,e)=>{const f=n("ShoppingBag"),k=n("el-icon"),u=n("el-button"),T=n("el-input"),g=n("el-form-item"),z=n("el-form"),$=n("el-card"),ne=n("el-empty"),_=n("el-table-column"),q=n("el-tag"),re=n("el-table"),ie=n("el-option"),ue=n("el-select"),de=n("el-date-picker"),ce=n("el-input-number"),P=n("el-dialog"),y=n("el-descriptions-item"),me=n("el-descriptions"),pe=_e("loading");return v(),j("div",Ve,[w("div",Ie,[w("h1",Se,[l(k,{class:"title-icon"},{default:a(()=>[l(f)]),_:1}),e[10]||(e[10]=s(" 销售订单管理 ",-1))]),e[11]||(e[11]=w("p",{class:"page-subtitle"},"管理销售订单，处理发货开票流程",-1))]),l($,{class:"main-card",shadow:"hover"},{header:a(()=>[w("div",Oe,[e[13]||(e[13]=w("span",{style:{"font-size":"18px","font-weight":"600"}},"销售订单列表",-1)),G("ACCOUNTANT")?(v(),N(u,{key:0,type:"primary",onClick:Y},{default:a(()=>[l(k,null,{default:a(()=>[l(Ne(be))]),_:1}),e[12]||(e[12]=s(" 新增订单 ",-1))]),_:1})):M("",!0)])]),default:a(()=>[l($,{class:"search-card",shadow:"never",style:{"margin-bottom":"20px"}},{default:a(()=>[l(z,{inline:!0,model:r},{default:a(()=>[l(g,{label:"发票号码"},{default:a(()=>[l(T,{modelValue:r.invoiceNo,"onUpdate:modelValue":e[0]||(e[0]=o=>r.invoiceNo=o),placeholder:"请输入发票号码",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),l(g,{label:"客户名称"},{default:a(()=>[l(T,{modelValue:r.customerName,"onUpdate:modelValue":e[1]||(e[1]=o=>r.customerName=o),placeholder:"请输入客户名称",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),l(g,null,{default:a(()=>[l(u,{type:"primary",onClick:ee},{default:a(()=>[...e[14]||(e[14]=[s("查询",-1)])]),_:1}),l(u,{onClick:te},{default:a(()=>[...e[15]||(e[15]=[s("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),!I.value&&R.value.length===0?(v(),N(ne,{key:0,description:"暂无销售订单数据","image-size":120},{default:a(()=>[l(u,{type:"primary",onClick:Y},{default:a(()=>[...e[16]||(e[16]=[s("新增订单",-1)])]),_:1}),l(u,{type:"success",onClick:Z,style:{"margin-left":"10px"}},{default:a(()=>[...e[17]||(e[17]=[s("创建测试订单",-1)])]),_:1})]),_:1})):ye((v(),N(re,{key:1,data:R.value,stripe:"",style:{width:"100%"}},{default:a(()=>[l(_,{prop:"id",label:"订单ID",width:"100"}),l(_,{prop:"customerName",label:"客户名称","min-width":"180"}),l(_,{prop:"invoiceNo",label:"发票号码",width:"150"}),l(_,{prop:"invoiceDate",label:"发票日期",width:"120"},{default:a(({row:o})=>[s(p(F(o.invoiceDate)),1)]),_:1}),l(_,{prop:"totalAmount",label:"订单金额",width:"140",align:"right"},{default:a(({row:o})=>[s(p(L(o.totalAmount)),1)]),_:1}),l(_,{prop:"status",label:"状态",width:"120"},{default:a(({row:o})=>[l(q,{type:U(o.status)},{default:a(()=>[s(p(B(o.status)),1)]),_:2},1032,["type"])]),_:1}),l(_,{label:"操作",width:"220"},{default:a(({row:o})=>[l(u,{type:"info",size:"small",onClick:fe=>le(o)},{default:a(()=>[...e[18]||(e[18]=[s("查看",-1)])]),_:1},8,["onClick"]),W(o)&&K("ACCOUNTANT","AUDITOR")?(v(),N(u,{key:0,type:"success",size:"small",onClick:fe=>ae(o),style:{"margin-left":"8px"}},{default:a(()=>[...e[19]||(e[19]=[s(" 发货开票 ",-1)])]),_:1},8,["onClick"])):M("",!0)]),_:1})]),_:1},8,["data"])),[[pe,I.value]])]),_:1}),l(P,{modelValue:b.value,"onUpdate:modelValue":e[7]||(e[7]=o=>b.value=o),title:"新增销售订单",width:"600px"},{footer:a(()=>[l(u,{onClick:e[6]||(e[6]=o=>b.value=!1)},{default:a(()=>[...e[20]||(e[20]=[s("取消",-1)])]),_:1}),l(u,{type:"primary",onClick:oe,loading:h.value},{default:a(()=>[...e[21]||(e[21]=[s("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[l(z,{ref_key:"formRef",ref:O,model:i,rules:Q,"label-width":"120px"},{default:a(()=>[l(g,{label:"客户",prop:"customerId"},{default:a(()=>[l(ue,{modelValue:i.customerId,"onUpdate:modelValue":e[2]||(e[2]=o=>i.customerId=o),placeholder:"请选择客户",filterable:"",style:{width:"100%"}},{default:a(()=>[(v(!0),j(De,null,we(x.value,o=>(v(),N(ie,{key:o.id,label:`${o.customerName} (${o.taxId||"无税号"})`,value:o.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(g,{label:"发票号码",prop:"invoiceNo"},{default:a(()=>[l(T,{modelValue:i.invoiceNo,"onUpdate:modelValue":e[3]||(e[3]=o=>i.invoiceNo=o),placeholder:"请输入发票号码"},null,8,["modelValue"])]),_:1}),l(g,{label:"发票日期",prop:"invoiceDate"},{default:a(()=>[l(de,{modelValue:i.invoiceDate,"onUpdate:modelValue":e[4]||(e[4]=o=>i.invoiceDate=o),type:"date",placeholder:"请选择发票日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(g,{label:"订单金额",prop:"totalAmount"},{default:a(()=>[l(ce,{modelValue:i.totalAmount,"onUpdate:modelValue":e[5]||(e[5]=o=>i.totalAmount=o),min:0,precision:2,step:100,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(P,{modelValue:S.value,"onUpdate:modelValue":e[9]||(e[9]=o=>S.value=o),title:"订单详情",width:"700px"},{footer:a(()=>[l(u,{onClick:e[8]||(e[8]=o=>S.value=!1)},{default:a(()=>[...e[22]||(e[22]=[s("关闭",-1)])]),_:1})]),default:a(()=>[c.value?(v(),N(me,{key:0,column:2,border:""},{default:a(()=>[l(y,{label:"订单ID"},{default:a(()=>[s(p(c.value.id),1)]),_:1}),l(y,{label:"状态"},{default:a(()=>[l(q,{type:U(c.value.status)},{default:a(()=>[s(p(B(c.value.status)),1)]),_:1},8,["type"])]),_:1}),l(y,{label:"客户名称"},{default:a(()=>[s(p(c.value.customerName),1)]),_:1}),l(y,{label:"发票号码"},{default:a(()=>[s(p(c.value.invoiceNo||"-"),1)]),_:1}),l(y,{label:"发票日期"},{default:a(()=>[s(p(F(c.value.invoiceDate)),1)]),_:1}),l(y,{label:"订单金额"},{default:a(()=>[s(p(L(c.value.totalAmount)),1)]),_:1})]),_:1})):M("",!0)]),_:1},8,["modelValue"])])}}},Me=Ae(ke,[["__scopeId","data-v-3a9cfc70"]]);export{Me as default};
