import{a as i,r as q,n as be,o as De,b as s,p as Ve,c as F,d as p,e as V,f as t,g as o,w as a,u as ee,m as we,z as b,q as Ae,t as u,H as te,B as Ce,F as Ie,C as ke,E as f}from"./index-CAVot8kD.js";import{_ as xe,p as w,v as B}from"./_plugin-vue_export-helper-CZBBfLPA.js";const Ne={class:"purchase-order-management",style:{padding:"20px"}},Oe={class:"page-header"},he={class:"page-title"},Ee={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Re={key:1,class:"text-muted"},Me={key:1,class:"text-muted"},Fe={style:{"margin-top":"5px",color:"#909399","font-size":"12px"}},Te={__name:"PurchaseOrderManagement",setup(Ye){const x=i([]),T=i([]),N=i(!1),A=i(!1),O=i(!1),C=i(!1),Y=i(!1),S=i(!1),h=i(null),L=i(null),d=i(null),E=i(null),m=q({vendorName:"",status:""}),c=q({vendorId:null,orderDate:"",totalAmount:0}),v=q({actualAmount:0,receiptDate:""}),le={vendorId:[{required:!0,message:"请选择供应商",trigger:"change"}],orderDate:[{required:!0,message:"请选择订单日期",trigger:"change"}],totalAmount:[{required:!0,message:"请输入订单金额",trigger:"blur"},{type:"number",min:.01,message:"订单金额必须大于 0",trigger:"blur"}]},ae={actualAmount:[{required:!0,message:"请输入实际金额",trigger:"blur"},{type:"number",min:.01,message:"实际金额必须大于 0",trigger:"blur"}],receiptDate:[{required:!0,message:"请选择收货日期",trigger:"change"}]},j=be(()=>{try{if(!Array.isArray(x.value))return[];let l=x.value;return m.vendorName&&(l=l.filter(e=>{var D;return(D=e==null?void 0:e.vendorName)==null?void 0:D.toLowerCase().includes(m.vendorName.toLowerCase())})),m.status&&(l=l.filter(e=>(e==null?void 0:e.status)===m.status)),l}catch(l){return console.error("filteredPurchaseOrders 計算錯誤:",l),[]}}),P=l=>l==null?"0.00":Number(l).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),R=l=>l?typeof l=="string"?l:new Date(l).toLocaleDateString("zh-CN"):"-",H=l=>({DRAFT:"info",CONFIRMED:"",RECEIVED:"success",CANCELLED:"danger"})[l]||"",G=l=>({DRAFT:"草稿",CONFIRMED:"已确认",RECEIVED:"已入库",CANCELLED:"已取消"})[l]||l,re=l=>l.status==="DRAFT"||l.status==="CONFIRMED",I=async()=>{N.value=!0;try{const l=await w.getAllPurchaseOrders();x.value=Array.isArray(l)?l:[]}catch(l){console.error("獲取訂單列表失敗:",l),f.error(l.message||"獲取訂單列表失敗，請檢查後端服務是否啟動"),x.value=[]}finally{N.value=!1}},oe=async()=>{try{const l=await B.getAllVendors();T.value=Array.isArray(l)?l:[]}catch(l){console.error("獲取供應商列表失敗:",l),T.value=[]}},se=async()=>{try{const l=await B.getAllVendors();if(!l||l.length===0){f.info("沒有供應商數據，正在創建測試供應商...");const n=await B.createVendor({vendorName:"測試供應商",taxId:"TEST001",settlementCurrency:"CNY",status:"有效"});f.success("測試供應商創建成功");const K=await w.createPurchaseOrder({vendorId:n.id,orderDate:new Date().toISOString().split("T")[0],totalAmount:8e3});f.success("測試訂單創建成功！"),await I();return}const e=l[0],D=await w.createPurchaseOrder({vendorId:e.id,orderDate:new Date().toISOString().split("T")[0],totalAmount:8e3});f.success("測試訂單創建成功！"),await I()}catch(l){console.error("創建測試訂單失敗:",l),f.error(l.message||"創建測試訂單失敗")}},ne=()=>{},ue=()=>{m.vendorName="",m.status=""},J=()=>{pe(),A.value=!0},de=async l=>{try{const e=await w.getPurchaseOrderById(l.id);d.value=e,O.value=!0}catch(e){console.error("獲取訂單詳情失敗:",e),f.error(e.message||"獲取訂單詳情失敗")}},ie=l=>{E.value=l,v.actualAmount=Number(l.totalAmount)||0,v.receiptDate=new Date().toISOString().split("T")[0],C.value=!0},me=async()=>{if(!(!L.value||!E.value))try{await L.value.validate(),S.value=!0,await w.receiveOrder(E.value.id,{actualAmount:v.actualAmount,receiptDate:v.receiptDate}),f.success("收貨成功！已自動生成應付賬款憑證"),C.value=!1,await I()}catch(l){l!==!1&&(console.error("收貨失敗:",l),f.error(l.message||"收貨失敗"))}finally{S.value=!1}},ce=async()=>{if(h.value)try{await h.value.validate(),Y.value=!0;const l={vendorId:c.vendorId,orderDate:c.orderDate,totalAmount:c.totalAmount};await w.createPurchaseOrder(l),f.success("新增訂單成功"),A.value=!1,await I()}catch(l){l!==!1&&(console.error("提交失敗:",l),f.error(l.message||"提交失敗"))}finally{Y.value=!1}},pe=()=>{var l;Object.assign(c,{vendorId:null,orderDate:"",totalAmount:0}),(l=h.value)==null||l.clearValidate()};return De(()=>{console.log("PurchaseOrderManagement 組件已掛載"),I(),oe()}),(l,e)=>{const D=s("el-icon"),n=s("el-button"),K=s("el-input"),_=s("el-form-item"),k=s("el-option"),Q=s("el-select"),U=s("el-form"),W=s("el-card"),fe=s("el-empty"),g=s("el-table-column"),M=s("el-tag"),ve=s("el-table"),X=s("el-date-picker"),Z=s("el-input-number"),z=s("el-dialog"),y=s("el-descriptions-item"),_e=s("el-descriptions"),ge=s("el-alert"),ye=Ve("loading");return p(),F("div",Ne,[V("div",Oe,[V("h1",he,[t(D,{class:"title-icon"},{default:a(()=>[t(ee(we))]),_:1}),e[13]||(e[13]=o(" 采购订单管理 ",-1))]),e[14]||(e[14]=V("p",{class:"page-subtitle"},"管理采购订单，处理收货入库流程",-1))]),t(W,{class:"main-card",shadow:"hover"},{header:a(()=>[V("div",Ee,[e[16]||(e[16]=V("span",{style:{"font-size":"18px","font-weight":"600"}},"采购订单列表",-1)),t(n,{type:"primary",onClick:J},{default:a(()=>[t(D,null,{default:a(()=>[t(ee(Ce))]),_:1}),e[15]||(e[15]=o(" 新增订单 ",-1))]),_:1})])]),default:a(()=>[t(W,{class:"search-card",shadow:"never",style:{"margin-bottom":"20px"}},{default:a(()=>[t(U,{inline:!0,model:m},{default:a(()=>[t(_,{label:"供应商名称"},{default:a(()=>[t(K,{modelValue:m.vendorName,"onUpdate:modelValue":e[0]||(e[0]=r=>m.vendorName=r),placeholder:"请输入供应商名称",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1}),t(_,{label:"状态"},{default:a(()=>[t(Q,{modelValue:m.status,"onUpdate:modelValue":e[1]||(e[1]=r=>m.status=r),placeholder:"请选择状态",clearable:"",style:{width:"150px"}},{default:a(()=>[t(k,{label:"草稿",value:"DRAFT"}),t(k,{label:"已确认",value:"CONFIRMED"}),t(k,{label:"已入库",value:"RECEIVED"}),t(k,{label:"已取消",value:"CANCELLED"})]),_:1},8,["modelValue"])]),_:1}),t(_,null,{default:a(()=>[t(n,{type:"primary",onClick:ne},{default:a(()=>[...e[17]||(e[17]=[o("查询",-1)])]),_:1}),t(n,{onClick:ue},{default:a(()=>[...e[18]||(e[18]=[o("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),!N.value&&j.value.length===0?(p(),b(fe,{key:0,description:"暂无采购订单数据","image-size":120},{default:a(()=>[t(n,{type:"primary",onClick:J},{default:a(()=>[...e[19]||(e[19]=[o("新增订单",-1)])]),_:1}),t(n,{type:"success",onClick:se,style:{"margin-left":"10px"}},{default:a(()=>[...e[20]||(e[20]=[o("创建测试订单",-1)])]),_:1})]),_:1})):Ae((p(),b(ve,{key:1,data:j.value,stripe:"",style:{width:"100%"}},{default:a(()=>[t(g,{prop:"id",label:"订单ID",width:"100"}),t(g,{prop:"vendorName",label:"供应商名称","min-width":"180"}),t(g,{prop:"orderDate",label:"订单日期",width:"120"},{default:a(({row:r})=>[o(u(R(r.orderDate)),1)]),_:1}),t(g,{prop:"receiptDate",label:"收货日期",width:"120"},{default:a(({row:r})=>[o(u(R(r.receiptDate)||"-"),1)]),_:1}),t(g,{prop:"totalAmount",label:"订单金额",width:"140",align:"right"},{default:a(({row:r})=>[o(u(P(r.totalAmount)),1)]),_:1}),t(g,{prop:"status",label:"状态",width:"120"},{default:a(({row:r})=>[t(M,{type:H(r.status)},{default:a(()=>[o(u(G(r.status)),1)]),_:2},1032,["type"])]),_:1}),t(g,{prop:"autoTransactionId",label:"关联凭证",width:"120"},{default:a(({row:r})=>[r.autoTransactionId?(p(),b(M,{key:0,type:"success",size:"small"},{default:a(()=>[o(" #"+u(r.autoTransactionId),1)]),_:2},1024)):(p(),F("span",Re,"-"))]),_:1}),t(g,{label:"操作",width:"220"},{default:a(({row:r})=>[t(n,{type:"info",size:"small",onClick:$=>de(r)},{default:a(()=>[...e[21]||(e[21]=[o("查看",-1)])]),_:1},8,["onClick"]),re(r)?(p(),b(n,{key:0,type:"success",size:"small",onClick:$=>ie(r),style:{"margin-left":"8px"}},{default:a(()=>[...e[22]||(e[22]=[o(" 收货入库 ",-1)])]),_:1},8,["onClick"])):te("",!0)]),_:1})]),_:1},8,["data"])),[[ye,N.value]])]),_:1}),t(z,{modelValue:A.value,"onUpdate:modelValue":e[6]||(e[6]=r=>A.value=r),title:"新增采购订单",width:"600px"},{footer:a(()=>[t(n,{onClick:e[5]||(e[5]=r=>A.value=!1)},{default:a(()=>[...e[23]||(e[23]=[o("取消",-1)])]),_:1}),t(n,{type:"primary",onClick:ce,loading:Y.value},{default:a(()=>[...e[24]||(e[24]=[o("确定",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(U,{ref_key:"formRef",ref:h,model:c,rules:le,"label-width":"120px"},{default:a(()=>[t(_,{label:"供应商",prop:"vendorId"},{default:a(()=>[t(Q,{modelValue:c.vendorId,"onUpdate:modelValue":e[2]||(e[2]=r=>c.vendorId=r),placeholder:"请选择供应商",filterable:"",style:{width:"100%"}},{default:a(()=>[(p(!0),F(Ie,null,ke(T.value,r=>(p(),b(k,{key:r.id,label:`${r.vendorName} (${r.taxId||"无税号"})`,value:r.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(_,{label:"订单日期",prop:"orderDate"},{default:a(()=>[t(X,{modelValue:c.orderDate,"onUpdate:modelValue":e[3]||(e[3]=r=>c.orderDate=r),type:"date",placeholder:"请选择订单日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1}),t(_,{label:"订单金额",prop:"totalAmount"},{default:a(()=>[t(Z,{modelValue:c.totalAmount,"onUpdate:modelValue":e[4]||(e[4]=r=>c.totalAmount=r),min:0,precision:2,step:100,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),t(z,{modelValue:O.value,"onUpdate:modelValue":e[8]||(e[8]=r=>O.value=r),title:"订单详情",width:"700px"},{footer:a(()=>[t(n,{onClick:e[7]||(e[7]=r=>O.value=!1)},{default:a(()=>[...e[25]||(e[25]=[o("关闭",-1)])]),_:1})]),default:a(()=>[d.value?(p(),b(_e,{key:0,column:2,border:""},{default:a(()=>[t(y,{label:"订单ID"},{default:a(()=>[o(u(d.value.id),1)]),_:1}),t(y,{label:"状态"},{default:a(()=>[t(M,{type:H(d.value.status)},{default:a(()=>[o(u(G(d.value.status)),1)]),_:1},8,["type"])]),_:1}),t(y,{label:"供应商名称"},{default:a(()=>[o(u(d.value.vendorName),1)]),_:1}),t(y,{label:"供应商ID"},{default:a(()=>[o(u(d.value.vendorId),1)]),_:1}),t(y,{label:"订单日期"},{default:a(()=>[o(u(R(d.value.orderDate)),1)]),_:1}),t(y,{label:"收货日期"},{default:a(()=>[o(u(R(d.value.receiptDate)||"-"),1)]),_:1}),t(y,{label:"订单金额"},{default:a(()=>[o(u(P(d.value.totalAmount)),1)]),_:1}),t(y,{label:"关联凭证"},{default:a(()=>[d.value.autoTransactionId?(p(),b(M,{key:0,type:"success"},{default:a(()=>[o(" 凭证 #"+u(d.value.autoTransactionId),1)]),_:1})):(p(),F("span",Me,"尚未生成凭证"))]),_:1})]),_:1})):te("",!0)]),_:1},8,["modelValue"]),t(z,{modelValue:C.value,"onUpdate:modelValue":e[12]||(e[12]=r=>C.value=r),title:"收货入库",width:"500px"},{footer:a(()=>[t(n,{onClick:e[11]||(e[11]=r=>C.value=!1)},{default:a(()=>[...e[27]||(e[27]=[o("取消",-1)])]),_:1}),t(n,{type:"success",onClick:me,loading:S.value},{default:a(()=>[...e[28]||(e[28]=[o("确认收货",-1)])]),_:1},8,["loading"])]),default:a(()=>[t(ge,{type:"info",closable:!1,style:{"margin-bottom":"20px"}},{default:a(()=>[...e[26]||(e[26]=[o(" 收货后将自动生成应付账款凭证 ",-1)])]),_:1}),t(U,{ref_key:"receiveFormRef",ref:L,model:v,rules:ae,"label-width":"120px"},{default:a(()=>[t(_,{label:"实际金额",prop:"actualAmount"},{default:a(()=>{var r;return[t(Z,{modelValue:v.actualAmount,"onUpdate:modelValue":e[9]||(e[9]=$=>v.actualAmount=$),min:0,precision:2,step:100,style:{width:"100%"}},null,8,["modelValue"]),V("div",Fe," 订单金额："+u(P((r=E.value)==null?void 0:r.totalAmount)),1)]}),_:1}),t(_,{label:"收货日期",prop:"receiptDate"},{default:a(()=>[t(X,{modelValue:v.receiptDate,"onUpdate:modelValue":e[10]||(e[10]=r=>v.receiptDate=r),type:"date",placeholder:"请选择收货日期",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Pe=xe(Te,[["__scopeId","data-v-184f7093"]]);export{Pe as default};
