import{a as i,r as G,o as Ve,b as s,p as Ae,c as f,d as u,e as b,f as l,g as o,w as t,u as Q,K as we,z as _,q as Ce,t as c,H as L,B as Ne,F as X,C as Z,E as k}from"./index-CAVot8kD.js";import{_ as Re,b as S,v as he,a as Ee}from"./_plugin-vue_export-helper-CZBBfLPA.js";const Pe={class:"payment-management",style:{padding:"20px"}},qe={class:"page-header"},Se={class:"page-title"},Me={style:{display:"flex","justify-content":"space-between","align-items":"center"}},Fe={class:"amount-text"},Te={key:0,class:"text-success"},Ue={key:1,class:"text-muted"},$e={key:1,class:"text-muted"},ze={class:"amount-text large"},Be={key:0,class:"text-success"},Ye={key:1,class:"text-muted"},Ge={key:1,class:"text-muted"},Le={__name:"PaymentManagement",setup(He){const C=i([]),ee=()=>{try{const a=localStorage.getItem("auth_roles");C.value=a?JSON.parse(a):[]}catch{C.value=[]}},te=a=>C.value.includes(a),le=(...a)=>a.some(e=>C.value.includes(e)),N=i([]),M=i([]),F=i([]),R=i(!1),I=i(!1),h=i(!1),D=i(!1),T=i(!1),U=i(!1),$=i(null),E=i(null),r=i(null),P=i(null),x=G({status:"PENDING"}),d=G({vendorId:null,bankAccountId:null,amount:0,requestDate:""}),V=G({bankReceiptId:""}),ae={vendorId:[{required:!0,message:"请选择供应商",trigger:"change"}],bankAccountId:[{required:!0,message:"请选择银行账户",trigger:"change"}],amount:[{required:!0,message:"请输入付款金额",trigger:"blur"},{type:"number",min:.01,message:"付款金额必须大于 0",trigger:"blur"}]},H=a=>a==null?"0.00":Number(a).toLocaleString("zh-CN",{minimumFractionDigits:2,maximumFractionDigits:2}),O=a=>a?typeof a=="string"?a:new Date(a).toLocaleDateString("zh-CN"):"-",j=a=>({PENDING:"warning",PAID:"success",FAILED:"danger"})[a]||"",J=a=>({PENDING:"待执行",PAID:"已支付",FAILED:"支付失败"})[a]||a,ne=a=>a.status==="PENDING",g=async()=>{R.value=!0;try{const a=await S.getPaymentsByStatus(x.status);N.value=Array.isArray(a)?a:[]}catch(a){console.error("获取付款申请列表失败:",a),k.error(a.message||"获取付款申请列表失败，请检查后端服务是否启动"),N.value=[]}finally{R.value=!1}},oe=async()=>{try{const a=await he.getAllVendors();M.value=Array.isArray(a)?a:[]}catch(a){console.error("获取供应商列表失败:",a),M.value=[]}},se=async()=>{try{const a=await Ee.getAllAccounts();F.value=Array.isArray(a)?a.filter(e=>{var A;return((A=e.code)==null?void 0:A.startsWith("1"))||e.type==="ASSET"}):[]}catch(a){console.error("获取银行账户列表失败:",a),F.value=[]}},ue=()=>{g()},re=()=>{g()},de=()=>{x.status="PENDING",g()},K=()=>{fe(),I.value=!0},ie=async a=>{try{const e=await S.getPaymentById(a.id);r.value=e,h.value=!0}catch(e){console.error("获取付款申请详情失败:",e),k.error(e.message||"获取付款申请详情失败")}},ce=a=>{P.value=a,V.bankReceiptId="",D.value=!0},me=async()=>{if(P.value)try{U.value=!0,$.value=P.value.id,await S.executePayment(P.value.id,{success:!0,bankReceiptId:V.bankReceiptId||null,bankReceiptRaw:null}),k.success("付款执行成功！已自动生成付款凭证"),D.value=!1,await g()}catch(a){console.error("执行付款失败:",a),k.error(a.message||"执行付款失败")}finally{U.value=!1,$.value=null}},pe=async()=>{if(E.value)try{await E.value.validate(),T.value=!0;const a={vendorId:d.vendorId,bankAccountId:d.bankAccountId,amount:d.amount,requestDate:d.requestDate||null};await S.createPaymentRequest(a),k.success("新增付款申请成功"),I.value=!1,await g()}catch(a){a!==!1&&(console.error("提交失败:",a),k.error(a.message||"提交失败"))}finally{T.value=!1}},fe=()=>{var a;Object.assign(d,{vendorId:null,bankAccountId:null,amount:0,requestDate:""}),(a=E.value)==null||a.clearValidate()};return Ve(()=>{ee(),g(),oe(),se()}),(a,e)=>{const A=s("el-icon"),m=s("el-button"),w=s("el-option"),z=s("el-select"),y=s("el-form-item"),B=s("el-form"),W=s("el-card"),_e=s("el-empty"),v=s("el-table-column"),q=s("el-tag"),ve=s("el-table"),ye=s("el-input-number"),be=s("el-date-picker"),Y=s("el-dialog"),p=s("el-descriptions-item"),ge=s("el-descriptions"),ke=s("el-alert"),Ie=s("el-input"),De=Ae("loading");return u(),f("div",Pe,[b("div",qe,[b("h1",Se,[l(A,{class:"title-icon"},{default:t(()=>[l(Q(we))]),_:1}),e[12]||(e[12]=o(" 付款管理 ",-1))]),e[13]||(e[13]=b("p",{class:"page-subtitle"},"管理供应商付款申请和执行付款",-1))]),l(W,{class:"main-card",shadow:"hover"},{header:t(()=>[b("div",Me,[e[15]||(e[15]=b("span",{style:{"font-size":"18px","font-weight":"600"}},"付款申请列表",-1)),le("ACCOUNTANT","CASHIER")?(u(),_(m,{key:0,type:"primary",onClick:K},{default:t(()=>[l(A,null,{default:t(()=>[l(Q(Ne))]),_:1}),e[14]||(e[14]=o(" 新增付款申请 ",-1))]),_:1})):L("",!0)])]),default:t(()=>[l(W,{class:"search-card",shadow:"never",style:{"margin-bottom":"20px"}},{default:t(()=>[l(B,{inline:!0,model:x},{default:t(()=>[l(y,{label:"状态"},{default:t(()=>[l(z,{modelValue:x.status,"onUpdate:modelValue":e[0]||(e[0]=n=>x.status=n),placeholder:"请选择状态",clearable:"",style:{width:"200px"},onChange:ue},{default:t(()=>[l(w,{label:"待执行",value:"PENDING"}),l(w,{label:"已支付",value:"PAID"}),l(w,{label:"支付失败",value:"FAILED"})]),_:1},8,["modelValue"])]),_:1}),l(y,null,{default:t(()=>[l(m,{type:"primary",onClick:re},{default:t(()=>[...e[16]||(e[16]=[o("查询",-1)])]),_:1}),l(m,{onClick:de},{default:t(()=>[...e[17]||(e[17]=[o("重置",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),_:1}),!R.value&&N.value.length===0?(u(),_(_e,{key:0,description:"暂无付款申请数据","image-size":120},{default:t(()=>[l(m,{type:"primary",onClick:K},{default:t(()=>[...e[18]||(e[18]=[o("新增付款申请",-1)])]),_:1})]),_:1})):Ce((u(),_(ve,{key:1,data:N.value,stripe:"",style:{width:"100%"}},{default:t(()=>[l(v,{prop:"id",label:"申请ID",width:"100"}),l(v,{prop:"vendorName",label:"供应商","min-width":"180"}),l(v,{prop:"requestDate",label:"申请日期",width:"120"},{default:t(({row:n})=>[o(c(O(n.requestDate)),1)]),_:1}),l(v,{prop:"amount",label:"付款金额",width:"140",align:"right"},{default:t(({row:n})=>[b("span",Fe,c(H(n.amount)),1)]),_:1}),l(v,{prop:"status",label:"状态",width:"120"},{default:t(({row:n})=>[l(q,{type:j(n.status)},{default:t(()=>[o(c(J(n.status)),1)]),_:2},1032,["type"])]),_:1}),l(v,{prop:"bankReceiptId",label:"银行回单号",width:"150"},{default:t(({row:n})=>[n.bankReceiptId?(u(),f("span",Te,c(n.bankReceiptId),1)):(u(),f("span",Ue,"-"))]),_:1}),l(v,{prop:"autoTransactionId",label:"关联凭证",width:"120"},{default:t(({row:n})=>[n.autoTransactionId?(u(),_(q,{key:0,type:"success",size:"small"},{default:t(()=>[o(" #"+c(n.autoTransactionId),1)]),_:2},1024)):(u(),f("span",$e,"-"))]),_:1}),l(v,{label:"操作",width:"200"},{default:t(({row:n})=>[l(m,{type:"info",size:"small",onClick:xe=>ie(n)},{default:t(()=>[...e[19]||(e[19]=[o(" 查看 ",-1)])]),_:1},8,["onClick"]),ne(n)&&te("CASHIER")?(u(),_(m,{key:0,type:"success",size:"small",onClick:xe=>ce(n),style:{"margin-left":"8px"},loading:$.value===n.id},{default:t(()=>[...e[20]||(e[20]=[o(" 执行付款 ",-1)])]),_:1},8,["onClick","loading"])):L("",!0)]),_:1})]),_:1},8,["data"])),[[De,R.value]])]),_:1}),l(Y,{modelValue:I.value,"onUpdate:modelValue":e[6]||(e[6]=n=>I.value=n),title:"新增付款申请",width:"600px"},{footer:t(()=>[l(m,{onClick:e[5]||(e[5]=n=>I.value=!1)},{default:t(()=>[...e[21]||(e[21]=[o("取消",-1)])]),_:1}),l(m,{type:"primary",onClick:pe,loading:T.value},{default:t(()=>[...e[22]||(e[22]=[o(" 确定 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(B,{ref_key:"formRef",ref:E,model:d,rules:ae,"label-width":"120px"},{default:t(()=>[l(y,{label:"供应商",prop:"vendorId"},{default:t(()=>[l(z,{modelValue:d.vendorId,"onUpdate:modelValue":e[1]||(e[1]=n=>d.vendorId=n),placeholder:"请选择供应商",filterable:"",style:{width:"100%"}},{default:t(()=>[(u(!0),f(X,null,Z(M.value,n=>(u(),_(w,{key:n.id,label:`${n.vendorName} (${n.taxId||"无税号"})`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"银行账户",prop:"bankAccountId"},{default:t(()=>[l(z,{modelValue:d.bankAccountId,"onUpdate:modelValue":e[2]||(e[2]=n=>d.bankAccountId=n),placeholder:"请选择银行账户（资产科目）",filterable:"",style:{width:"100%"}},{default:t(()=>[(u(!0),f(X,null,Z(F.value,n=>(u(),_(w,{key:n.id,label:`${n.code} - ${n.name}`,value:n.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),l(y,{label:"付款金额",prop:"amount"},{default:t(()=>[l(ye,{modelValue:d.amount,"onUpdate:modelValue":e[3]||(e[3]=n=>d.amount=n),min:0,precision:2,step:100,style:{width:"100%"}},null,8,["modelValue"])]),_:1}),l(y,{label:"申请日期",prop:"requestDate"},{default:t(()=>[l(be,{modelValue:d.requestDate,"onUpdate:modelValue":e[4]||(e[4]=n=>d.requestDate=n),type:"date",placeholder:"选择日期（可选，默认今天）",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),l(Y,{modelValue:h.value,"onUpdate:modelValue":e[8]||(e[8]=n=>h.value=n),title:"付款申请详情",width:"700px"},{footer:t(()=>[l(m,{onClick:e[7]||(e[7]=n=>h.value=!1)},{default:t(()=>[...e[23]||(e[23]=[o("关闭",-1)])]),_:1})]),default:t(()=>[r.value?(u(),_(ge,{key:0,column:2,border:""},{default:t(()=>[l(p,{label:"申请ID"},{default:t(()=>[o(c(r.value.id),1)]),_:1}),l(p,{label:"状态"},{default:t(()=>[l(q,{type:j(r.value.status)},{default:t(()=>[o(c(J(r.value.status)),1)]),_:1},8,["type"])]),_:1}),l(p,{label:"供应商"},{default:t(()=>[o(c(r.value.vendorName),1)]),_:1}),l(p,{label:"供应商ID"},{default:t(()=>[o(c(r.value.vendorId),1)]),_:1}),l(p,{label:"申请日期"},{default:t(()=>[o(c(O(r.value.requestDate)),1)]),_:1}),l(p,{label:"付款金额"},{default:t(()=>[b("span",ze,c(H(r.value.amount)),1)]),_:1}),l(p,{label:"银行账户ID"},{default:t(()=>[o(c(r.value.bankAccountId||"-"),1)]),_:1}),l(p,{label:"银行回单号"},{default:t(()=>[r.value.bankReceiptId?(u(),f("span",Be,c(r.value.bankReceiptId),1)):(u(),f("span",Ye,"-"))]),_:1}),l(p,{label:"关联凭证",span:2},{default:t(()=>[r.value.autoTransactionId?(u(),_(q,{key:0,type:"success"},{default:t(()=>[o(" 凭证 #"+c(r.value.autoTransactionId),1)]),_:1})):(u(),f("span",Ge,"尚未生成凭证"))]),_:1})]),_:1})):L("",!0)]),_:1},8,["modelValue"]),l(Y,{modelValue:D.value,"onUpdate:modelValue":e[11]||(e[11]=n=>D.value=n),title:"执行付款",width:"500px"},{footer:t(()=>[l(m,{onClick:e[10]||(e[10]=n=>D.value=!1)},{default:t(()=>[...e[25]||(e[25]=[o("取消",-1)])]),_:1}),l(m,{type:"success",onClick:me,loading:U.value},{default:t(()=>[...e[26]||(e[26]=[o(" 确认执行付款 ",-1)])]),_:1},8,["loading"])]),default:t(()=>[l(ke,{type:"warning",closable:!1,style:{"margin-bottom":"20px"}},{default:t(()=>[...e[24]||(e[24]=[o(" 此操作将模拟银企直连执行付款，并自动生成付款凭证 ",-1)])]),_:1}),l(B,{ref:"executeFormRef",model:V,"label-width":"120px"},{default:t(()=>[l(y,{label:"银行回单号"},{default:t(()=>[l(Ie,{modelValue:V.bankReceiptId,"onUpdate:modelValue":e[9]||(e[9]=n=>V.bankReceiptId=n),placeholder:"请输入银行回单号（可选）"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}},Je=Re(Le,[["__scopeId","data-v-a8f99d9a"]]);export{Je as default};
